<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotions Analytics Insights Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #334155;
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
        }
        .card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.5);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }
        .header-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
        }
        select, input[type="radio"] {
            accent-color: #6366f1;
        }
        .button-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .button-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.3);
        }
        .button-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .list-item-hover:hover {
            background-color: rgba(99, 102, 241, 0.05);
            transform: translateX(4px);
            transition: all 0.2s ease;
        }
        .metric-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.9) 100%);
            border: 1px solid rgba(226, 232, 240, 0.6);
            border-radius: 1rem;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
        }
        .ai-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(249, 250, 251, 0.95) 100%);
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-radius: 1.5rem;
            backdrop-filter: blur(15px);
            box-shadow: 0 25px 50px rgba(99, 102, 241, 0.1);
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-6xl mx-auto py-8">
        <h1 class="text-4xl sm:text-5xl font-bold mb-4 header-gradient">Emotion-Driven Audience Intelligence AI</h1>
        <p class="text-lg text-slate-600 mb-10">
            AI-powered insights into how your audience feels, reacts, and engages.
            Analyze by industry or emotional response to uncover what truly moves your readers and drives content impact.
        </p>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Filter & Controls Section -->
            <section class="lg:col-span-1 card p-6">
                <h2 class="text-2xl font-semibold mb-4 text-slate-800">Analysis Perspective</h2>

                <div class="mb-6">
                    <label class="inline-flex items-center mr-4 cursor-pointer">
                        <input type="radio" name="filterType" value="industry" class="form-radio" checked>
                        <span class="ml-2 text-slate-700">Industry Analysis</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" name="filterType" value="emotion" class="form-radio">
                        <span class="ml-2 text-slate-700">Emotion Analysis</span>
                    </label>
                </div>

                <!-- Industry Filter -->
                <div id="industryFilter" class="mb-6">
                    <label for="selectIndustry" class="block text-slate-600 text-sm font-semibold mb-2">
                        Select an Industry to analyze
                    </label>
                    <select id="selectIndustry" class="shadow-sm border rounded-lg w-full py-3 px-4 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white border-slate-300 text-slate-700">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>

                <!-- Brand Filter -->
                <div id="brandFilter" class="mb-6">
                    <label for="selectBrand" class="block text-slate-600 text-sm font-semibold mb-2">
                        Select a Brand to analyze
                    </label>
                    <select id="selectBrand" class="shadow-sm border rounded-lg w-full py-3 px-4 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white border-slate-300 text-slate-700">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>

                <!-- Emotion Filter -->
                <div id="emotionFilter" class="mb-6 hidden">
                    <label for="selectEmotion" class="block text-slate-600 text-sm font-semibold mb-2">
                        Select an Emotion to analyze
                    </label>
                    <select id="selectEmotion" class="shadow-sm border rounded-lg w-full py-3 px-4 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white border-slate-300 text-slate-700">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>

            </section>

            <!-- Dashboard Insights Section -->
            <section class="lg:col-span-2 card p-6">
                <h2 class="text-2xl font-semibold mb-4 text-slate-800">Dashboard Insights</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Industry/Emotion Cards -->
                    <div id="topIndustriesCard" class="metric-card">
                        <h3 class="text-lg font-semibold text-blue-600 mb-3">Top 5 Industries</h3>
                        <ul id="topIndustriesList" class="text-slate-700 space-y-1">
                            <li>Loading...</li>
                        </ul>
                    </div>
                    <div id="topEmotionsCard" class="metric-card">
                        <h3 class="text-lg font-semibold text-emerald-600 mb-3">Top 5 Emotions</h3>
                        <ul id="topEmotionsList" class="text-slate-700 space-y-1">
                            <li>Loading...</li>
                        </ul>
                    </div>
                    
                    <!-- Audience Category -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold text-orange-500 mb-3">Top 5 Audience Segments</h3>
                        <ul id="topAudienceSegmentsList" class="text-slate-700 space-y-1">
                            <li>Loading...</li>
                        </ul>
                    </div>
                    
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold text-amber-600 mb-3">Target Generation</h3>
                        <p id="targetGeneration" class="text-slate-700 text-lg font-medium">Loading...</p>
                    </div>
                    
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold text-rose-500 mb-3">Top 5 Cultural Events</h3>
                        <ul id="topCulturalEventsList" class="text-slate-700 space-y-1">
                            <li>Loading...</li>
                        </ul>
                    </div>

                    <!-- Top 5 Site Sections moved here -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold text-pink-500 mb-3">Top 5 Site Sections</h3>
                        <ul id="topSiteSectionsList" class="text-slate-700 space-y-1">
                            <li>Loading...</li>
                        </ul>
                    </div>

                    <!-- Top 5 Job Titles moved here -->
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold text-cyan-600 mb-3">Top 5 Job Titles</h3>
                        <ul id="topJobTitlesList" class="text-slate-700 space-y-1">
                            <li>Loading...</li>
                        </ul>
                    </div>
                </div>

                <!-- Top 10 Topics Chart within Dashboard Insights -->
                <div class="metric-card">
                    <h3 class="text-lg font-semibold text-violet-600 mb-4">Top 10 Topics Analysis</h3>
                    <div style="position: relative; height: 200px; width: 100%;">
                        <canvas id="topicsChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- AI Sales Pitch Section -->
            <section class="lg:col-span-3 ai-section p-8">

                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-gradient-to-r from-indigo-100 to-purple-100 rounded-2xl mb-4 border border-indigo-200">
                        <svg class="w-6 h-6 text-indigo-600 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423L16.5 15.75l.394 1.183a2.25 2.25 0 001.423 1.423L19.5 18.75l-1.183.394a2.25 2.25 0 00-1.423 1.423z"></path>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold mb-3 header-gradient">AI Sales Pitch Generator</h2>
                    <p class="text-slate-600 text-base max-w-4xl mx-auto leading-relaxed">
                        Transform your filtered data into compelling B2B sales pitches.<br>
                        AI-powered insights tailored to your selected audience segments.
                    </p>
                </div>
                
                <div class="flex justify-center mb-6">
                    <button id="generatePitchBtn" class="button-primary text-lg px-8 py-4 shadow-lg transform transition-all duration-200 hover:scale-105">
                        <span class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            Generate AI Sales Pitch
                        </span>
                    </button>
                </div>
                
                <div id="pitchLoading" class="hidden text-center mb-4">
                    <div class="inline-flex items-center text-indigo-600 text-lg">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600 mr-3"></div>
                        Generating your personalized pitch...
                    </div>
                </div>
                
                <div id="pitchError" class="text-red-500 text-center mb-4 hidden"></div>
                
                <div class="bg-white/70 border border-slate-200 rounded-xl p-6 min-h-[150px] backdrop-filter backdrop-blur-sm">
                    <div class="flex items-start mb-3">
                        <div class="flex-shrink-0 w-8 h-8 rounded-xl flex items-center justify-center mr-3 bg-gradient-to-r from-cyan-500 to-blue-500">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-1l-4 4z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-800">Your Personalized Sales Pitch</h3>
                    </div>
                    <div id="salesPitchOutput" class="text-slate-700 leading-relaxed text-left prose prose-slate max-w-none">
                        <div class="flex items-center justify-center h-20 text-slate-400">
                            <div class="text-center">
                                <svg class="w-12 h-12 mx-auto mb-2 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"></path>
                                </svg>
                                <p>Click "Generate AI Sales Pitch" to create your targeted pitch</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 text-center text-sm text-slate-500">
                    <p>ðŸ’¡<strong>Tip:</strong> Adjust your filters above to target specific industries, emotions for more precise pitches</p>
                </div>
            </section>

        </main>
    </div>

    <script>
        // --- CONFIGURATION ---
        const JSON_DATA_PATH = 'article_emotions_data.json';
        const GEMINI_API_KEY = "AIzaSyDjG2hEnsqcTdudGBACaKFfi1sIRFrcAEU"; 

        // --- GLOBAL VARIABLES ---
        let allArticleData = [];
        let currentFilteredArticles = [];
        let currentFilterType = 'industry';
        let currentFilterValue = '';
        let currentBrandFilter = '';
        let topicsChart = null;

        // --- Data Key Mapping ---
        const DATA_KEY_MAPPING = {
            'industry': 'target_industries_1', 
            'emotion': 'emotion_segments_1',   
            'topic': 'core_topics_themes_1',   
            'generation': 'generational_groups_1', 
            'site_section': 'art_section',
            'brand': 'brandcode',     
            'pageviews': 'pageviews',          
            'users': 'users',                  
            'attention_time_mins': 'attention_time_mins',
            'audience_segment': 'existing_match1',
            'cultural_event': 'cultural_event_context_1',
            'job_title': 'job_titles'
        };

        // --- Helper Functions ---
        function normalizeValue(value) {
            return (value === null || value === undefined || value === '') ? '' : String(value).toLowerCase().trim();
        }

        function populateDropdown(selectElement, options) {
            selectElement.innerHTML = '<option value="">All</option>';
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = normalizeValue(option); 
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        }

        function toggleFilterVisibility() {
            const selectedFilterType = document.querySelector('input[name="filterType"]:checked').value;
            const industryFilterDiv = document.getElementById('industryFilter');
            const emotionFilterDiv = document.getElementById('emotionFilter');
            const brandFilterDiv = document.getElementById('brandFilter');
            
            console.log('Filter type changed to:', selectedFilterType);
            
            if (selectedFilterType === 'industry') {
                industryFilterDiv.classList.remove('hidden');
                brandFilterDiv.classList.remove('hidden');
                emotionFilterDiv.classList.add('hidden');
                console.log('Showing industry and brand filters, hiding emotion filter');
            } else if (selectedFilterType === 'emotion') {
                industryFilterDiv.classList.add('hidden');
                brandFilterDiv.classList.remove('hidden');
                emotionFilterDiv.classList.remove('hidden');
                console.log('Showing emotion and brand filters, hiding industry filter');
            }
            
            toggleCardsVisibility();
        }

        function toggleCardsVisibility() {
            const selectedFilterType = document.querySelector('input[name="filterType"]:checked').value;
            const topEmotionsCard = document.getElementById('topEmotionsCard');
            const topIndustriesCard = document.getElementById('topIndustriesCard');
            
            if (selectedFilterType === 'industry') {
                topIndustriesCard.classList.add('hidden');
                topEmotionsCard.classList.remove('hidden');
            } else if (selectedFilterType === 'emotion') {
                topEmotionsCard.classList.add('hidden');
                topIndustriesCard.classList.remove('hidden');
            }
        }

        function createTopicsChart(topicsData) {
            const ctx = document.getElementById('topicsChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (topicsChart) {
                topicsChart.destroy();
                topicsChart = null;
            }

            // Only use top 10 items
            const limitedData = topicsData.slice(0, 10);
            
            if (limitedData.length === 0) {
                // Clear the canvas if no data
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }

            const labels = limitedData.map(item => item.name.charAt(0).toUpperCase() + item.name.slice(1));
            const data = limitedData.map(item => item.count);

            topicsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Engagement Score',
                        data: data,
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 5,
                            bottom: 5,
                            left: 5,
                            right: 5
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            display: false,
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                color: '#64748b',
                                maxRotation: 45,
                                minRotation: 0,
                                font: {
                                    size: 10
                                },
                                maxTicksLimit: 10
                            },
                            grid: {
                                color: 'rgba(226, 232, 240, 0.5)'
                            }
                        }
                    },
                    animation: {
                        duration: 500
                    },
                    elements: {
                        bar: {
                            maxBarThickness: 60
                        }
                    }
                }
            });
        }

        function calculateTopMetricsWithCounts(data, key, metric = 'pageviews', limit = 10) {
            const actualKey = DATA_KEY_MAPPING[key];
            const actualMetric = DATA_KEY_MAPPING[metric]; 

            const counts = {};
            data.forEach(item => {
                const rawValue = item[actualKey];
                const score = parseFloat(item[actualMetric]) || 0;

                let valuesToProcess = [];
                if (typeof rawValue === 'string' && rawValue.startsWith('[') && rawValue.endsWith(']')) {
                    try {
                        const parsed = JSON.parse(rawValue.replace(/'/g, '"'));
                        if (Array.isArray(parsed)) {
                            valuesToProcess = parsed.filter(Boolean).map(normalizeValue);
                        } else {
                            valuesToProcess = [normalizeValue(rawValue)];
                        }
                    } catch (e) {
                        valuesToProcess = [normalizeValue(rawValue)];
                    }
                } else if (typeof rawValue === 'string') {
                    valuesToProcess = [normalizeValue(rawValue)];
                } else if (Array.isArray(rawValue)) {
                    valuesToProcess = rawValue.filter(Boolean).map(normalizeValue);
                } else {
                    valuesToProcess = rawValue != null ? [normalizeValue(rawValue)] : [];
                }
                
                valuesToProcess.forEach(value => {
                    if (value !== '') {
                        counts[value] = (counts[value] || 0) + score;
                    }
                });
            });

            const sortedItems = Object.entries(counts)
                .sort(([, countA], [, countB]) => countB - countA);

            return sortedItems.slice(0, limit).map(([name, count]) => ({ name, count }));
        }

        async function filterDataAndRender() {
            console.log('--- filterDataAndRender started ---');
            currentFilterType = document.querySelector('input[name="filterType"]:checked').value;
            
            const selectIndustry = document.getElementById('selectIndustry');
            const selectEmotion = document.getElementById('selectEmotion');
            const selectBrand = document.getElementById('selectBrand');
            
            currentFilterValue = normalizeValue(currentFilterType === 'industry' ? selectIndustry.value : selectEmotion.value);
            currentBrandFilter = normalizeValue(selectBrand.value);

            console.log(`Filter Type: ${currentFilterType}, Filter Value (normalized): "${currentFilterValue}", Brand Filter: "${currentBrandFilter}"`);
            console.log(`Total articles in dataset: ${allArticleData.length}`);

            const actualFilterKey = DATA_KEY_MAPPING[currentFilterType];
            const brandFilterKey = DATA_KEY_MAPPING['brand'];
            console.log(`Actual JSON Key for filter: ${actualFilterKey}, Brand Key: ${brandFilterKey}`);

            let filteredData = [...allArticleData];

            if (currentFilterValue !== "") {
                filteredData = filteredData.filter(article => {
                    const articleValue = article[actualFilterKey];
                    let valuesToProcess = [];
                    
                    if (typeof articleValue === 'string' && articleValue.startsWith('[') && articleValue.endsWith(']')) {
                        try {
                            const parsed = JSON.parse(articleValue.replace(/'/g, '"'));
                            if (Array.isArray(parsed)) {
                                valuesToProcess = parsed.filter(Boolean).map(normalizeValue);
                            } else {
                                valuesToProcess = [normalizeValue(articleValue)];
                            }
                        } catch (e) {
                            console.warn("Failed to parse stringified array, treating as single string:", articleValue, e);
                            valuesToProcess = [normalizeValue(articleValue)];
                        }
                    } else if (Array.isArray(articleValue)) {
                        valuesToProcess = articleValue.filter(Boolean).map(normalizeValue);
                    } else {
                        valuesToProcess = (articleValue !== null && articleValue !== undefined && articleValue !== '' ? [normalizeValue(articleValue)] : []);
                    }
                    
                    return valuesToProcess.some(val => val === currentFilterValue);
                });
            }

            if (currentBrandFilter !== "") {
                filteredData = filteredData.filter(article => {
                    const brandValue = article[brandFilterKey];
                    return normalizeValue(brandValue) === currentBrandFilter;
                });
            }

            currentFilteredArticles = filteredData;
            console.log(`Filtered to ${currentFilteredArticles.length} articles.`);

            // Debug: Log sample data to check structure
            if (currentFilteredArticles.length > 0) {
                console.log('Sample article data:', currentFilteredArticles[0]);
                console.log('Available keys:', Object.keys(currentFilteredArticles[0]));
            }

            try {
                const topEmotions = calculateTopMetrics(currentFilteredArticles, 'emotion', 'pageviews', 5);
                const topIndustries = calculateTopMetrics(currentFilteredArticles, 'industry', 'pageviews', 5);
                const topTopicsData = calculateTopMetricsWithCounts(currentFilteredArticles, 'topic', 'pageviews', 10);
                const targetGeneration = calculateMostCommon(currentFilteredArticles, 'generation');
                const topSiteSections = calculateTopMetrics(currentFilteredArticles, 'site_section', 'pageviews', 5);
                const topAudienceSegments = calculateTopMetrics(currentFilteredArticles, 'audience_segment', 'pageviews', 5);
                const topCulturalEvents = calculateTopMetrics(currentFilteredArticles, 'cultural_event', 'pageviews', 5);
                const topJobTitles = calculateTopMetrics(currentFilteredArticles, 'job_title', 'pageviews', 5);

                console.log('Calculated metrics:', {
                    topEmotions,
                    topIndustries,
                    topTopicsData,
                    targetGeneration,
                    topSiteSections,
                    topAudienceSegments,
                    topCulturalEvents,
                    topJobTitles
                });

                renderList(document.getElementById('topEmotionsList'), topEmotions);
                renderList(document.getElementById('topIndustriesList'), topIndustries);
                document.getElementById('targetGeneration').textContent = targetGeneration;
                renderList(document.getElementById('topSiteSectionsList'), topSiteSections);
                renderList(document.getElementById('topAudienceSegmentsList'), topAudienceSegments);
                renderList(document.getElementById('topCulturalEventsList'), topCulturalEvents);
                renderList(document.getElementById('topJobTitlesList'), topJobTitles);

                // Create the topics chart with filtered data
                if (topTopicsData && topTopics