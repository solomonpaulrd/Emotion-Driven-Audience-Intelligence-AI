<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotions Analytics Insights Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 2rem;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header-gradient {
            background-image: linear-gradient(to right, #34d399, #60a5fa);
            background-clip: text;
            color: transparent;
        }
        select, input[type="radio"] {
            accent-color: #60a5fa;
        }
        .button-primary {
            background-color: #34d399;
            color: #1a202c;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .button-primary:hover:not(:disabled) {
            background-color: #2fb380;
        }
        .button-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .list-item-hover:hover {
            background-color: #2d3643;
        }
        .api-key-input {
            background-color: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            border-radius: 0.375rem;
            padding: 0.5rem;
            width: 100%;
        }
        .api-key-input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 1px #60a5fa;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-6xl mx-auto py-8">
        <h1 class="text-4xl sm:text-5xl font-bold mb-4 header-gradient">Emotion-Driven Audience Intelligence AI</h1>
        <p class="text-lg text-gray-300 mb-10">
            AI-powered insights into how your audience feels, reacts, and engages.
            Analyze by industry or emotional response to uncover what truly moves your readers and drives content impact.
        </p>

        <!-- API Key Configuration -->
        <section class="card p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-yellow-400">⚙️ Configuration</h2>
            <div class="mb-4">
                <label for="apiKeyInput" class="block text-gray-400 text-sm font-bold mb-2">
                    Gemini API Key (Required for AI Sales Pitch)
                </label>
                <input 
                    type="password" 
                    id="apiKeyInput" 
                    class="api-key-input" 
                    placeholder="Enter your Gemini API key here..."
                    autocomplete="off"
                >
                <p class="text-xs text-gray-500 mt-1">
                    Get your free API key from <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-400 hover:underline">Google AI Studio</a>
                </p>
            </div>
        </section>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Filter & Controls Section -->
            <section class="lg:col-span-1 card p-6">
                <h2 class="text-2xl font-semibold mb-4">Analysis Perspective</h2>

                <div class="mb-6">
                    <label class="inline-flex items-center mr-4 cursor-pointer">
                        <input type="radio" name="filterType" value="industry" class="form-radio" checked>
                        <span class="ml-2 text-gray-300">Industry Analysis</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" name="filterType" value="emotion" class="form-radio">
                        <span class="ml-2 text-gray-300">Emotion Analysis</span>
                    </label>
                </div>

                <!-- Industry Filter -->
                <div id="industryFilter" class="mb-6">
                    <label for="selectIndustry" class="block text-gray-400 text-sm font-bold mb-2">
                        Select an Industry to analyze
                    </label>
                    <select id="selectIndustry" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 text-gray-200">
                        <option value="">All</option>
                    </select>
                </div>

                <!-- Brand Filter -->
                <div id="brandFilter" class="mb-6">
                    <label for="selectBrand" class="block text-gray-400 text-sm font-bold mb-2">
                        Select a Brand to analyze
                    </label>
                    <select id="selectBrand" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 text-gray-200">
                        <option value="">All</option>
                    </select>
                </div>

                <!-- Emotion Filter -->
                <div id="emotionFilter" class="mb-6 hidden">
                    <label for="selectEmotion" class="block text-gray-400 text-sm font-bold mb-2">
                        Select an Emotion to analyze
                    </label>
                    <select id="selectEmotion" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 text-gray-200">
                        <option value="">All</option>
                    </select>
                </div>

            </section>

            <!-- Dashboard Insights Section -->
            <section class="lg:col-span-2 card p-6">
                <h2 class="text-2xl font-semibold mb-4">Dashboard Insights</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Industry/Emotion Cards -->
                    <div id="topIndustriesCard" class="bg-gray-800 p-4 rounded-md">
                        <h3 class="text-lg font-semibold text-blue-400 mb-2">Top 5 Industries</h3>
                        <ul id="topIndustriesList" class="text-gray-300">
                            <li class="p-2">Loading...</li>
                        </ul>
                    </div>
                    <div id="topEmotionsCard" class="bg-gray-800 p-4 rounded-md">
                        <h3 class="text-lg font-semibold text-green-400 mb-2">Top 5 Emotions</h3>
                        <ul id="topEmotionsList" class="text-gray-300">
                            <li class="p-2">Loading...</li>
                        </ul>
                    </div>
                    
                    <!-- Audience Category -->
                    <div class="bg-gray-800 p-4 rounded-md">
                        <h3 class="text-lg font-semibold text-orange-400 mb-2">Top 5 Audience Segments</h3>
                        <ul id="topAudienceSegmentsList" class="text-gray-300">
                            <li class="p-2">Loading...</li>
                        </ul>
                    </div>
                    
                    <div class="bg-gray-800 p-4 rounded-md">
                        <h3 class="text-lg font-semibold text-yellow-400 mb-2">Target Generation</h3>
                        <p id="targetGeneration" class="text-gray-300 text-lg">Loading...</p>
                    </div>
                    
                    <div class="bg-gray-800 p-4 rounded-md">
                        <h3 class="text-lg font-semibold text-red-400 mb-2">Top 5 Cultural Events</h3>
                        <ul id="topCulturalEventsList" class="text-gray-300">
                            <li class="p-2">Loading...</li>
                        </ul>
                    </div>

                    <div class="bg-gray-800 p-4 rounded-md">
                        <h3 class="text-lg font-semibold text-pink-400 mb-2">Top 5 Site Sections</h3>
                        <ul id="topSiteSectionsList" class="text-gray-300">
                            <li class="p-2">Loading...</li>
                        </ul>
                    </div>

                    <div class="bg-gray-800 p-4 rounded-md">
                        <h3 class="text-lg font-semibold text-cyan-400 mb-2">Top 5 Job Titles</h3>
                        <ul id="topJobTitlesList" class="text-gray-300">
                            <li class="p-2">Loading...</li>
                        </ul>
                    </div>
                </div>

                <!-- Top 10 Topics Chart -->
                <div class="bg-gray-800 p-4 rounded-md">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4">Top 10 Topics Analysis</h3>
                    <div style="position: relative; height: 200px; width: 100%;">
                        <canvas id="topicsChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- AI Sales Pitch Section -->
            <section class="lg:col-span-3 card p-8 bg-gradient-to-br from-gray-800 to-gray-900">

                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-10 h-10 bg-gradient-to-r from-gray-400 via-green-300 to-blue-400 rounded-full mb-4">
                        <svg class="w-6 h-6 text-white opacity-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423L16.5 15.75l.394 1.183a2.25 2.25 0 001.423 1.423L19.5 18.75l-1.183.394a2.25 2.25 0 00-1.423 1.423z"></path>
                        </svg>
                    </div>

                    <h2 class="text-3xl font-bold mb-2 header-gradient">AI Sales Pitch Generator</h2>
                    <p class="text-gray-400 text-base max-w-4xl mx-auto">
                        The AI analyzes top-ranking metrics, then creates targeted B2B sales pitch summary for selected audience filter.
                    </p>
                </div>
                
                <div class="flex justify-center mb-6">
                    <button id="generatePitchBtn" class="button-primary text-lg px-8 py-4 shadow-lg transform transition-all duration-200 hover:scale-105 hover:shadow-xl">
                        <span class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            Generate AI Sales Pitch
                        </span>
                    </button>
                </div>
                
                <div id="pitchLoading" class="hidden text-center mb-4">
                    <div class="inline-flex items-center text-green-400 text-lg">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-400 mr-3"></div>
                        Generating your personalized pitch...
                    </div>
                </div>
                
                <div id="pitchError" class="text-red-400 text-center mb-4 hidden"></div>
                
                <div class="bg-gray-800 border border-gray-600 rounded-lg p-6 min-h-[150px]">
                    <div class="flex items-start mb-3">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3" style="background-color: #22d3ee;">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-1l-4 4z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-200">Your Personalized Sales Pitch</h3>
                    </div>
                    <div id="salesPitchOutput" class="text-gray-300 leading-relaxed text-left prose prose-invert max-w-none">
                        <div class="flex items-center justify-center h-20 text-gray-500">
                            <div class="text-center">
                                <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                <p>Enter your API key above and click "Generate AI Sales Pitch" to create your targeted pitch</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 text-center text-sm text-gray-500">
                    <p>💡<strong>Tip:</strong> Adjust your filters above to target specific industries, emotions for more precise pitches</p>
                </div>
            </section>

        </main>
    </div>

    <script>
        // Configuration
        const JSON_DATA_PATH = 'article_emotions_data.json';

        // Global Variables
        let allArticleData = [];
        let currentFilteredArticles = [];
        let currentFilterType = 'industry';
        let currentFilterValue = '';
        let currentBrandFilter = '';
        let topicsChart = null;

        // Data Key Mapping
        const DATA_KEY_MAPPING = {
            'industry': 'target_industries_1', 
            'emotion': 'emotion_segments_1',   
            'topic': 'core_topics_themes_1',   
            'generation': 'generational_groups_1', 
            'site_section': 'art_section',
            'brand': 'brandcode',     
            'pageviews': 'pageviews',          
            'users': 'users',                  
            'attention_time_mins': 'attention_time_mins',
            'audience_segment': 'existing_match1',
            'cultural_event': 'cultural_event_context_1',
            'job_title': 'job_titles'
        };

        // Helper Functions
        function normalizeValue(value) {
            return (value === null || value === undefined || value === '') ? '' : String(value).toLowerCase().trim();
        }

        function populateDropdown(selectElement, options) {
            selectElement.innerHTML = '<option value="">All</option>';
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = normalizeValue(option); 
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        }

        function toggleFilterVisibility() {
            const selectedFilterType = document.querySelector('input[name="filterType"]:checked').value;
            const industryFilterDiv = document.getElementById('industryFilter');
            const emotionFilterDiv = document.getElementById('emotionFilter');
            const brandFilterDiv = document.getElementById('brandFilter');
            
            if (selectedFilterType === 'industry') {
                industryFilterDiv.classList.remove('hidden');
                brandFilterDiv.classList.remove('hidden');
                emotionFilterDiv.classList.add('hidden');
            } else if (selectedFilterType === 'emotion') {
                industryFilterDiv.classList.add('hidden');
                brandFilterDiv.classList.remove('hidden');
                emotionFilterDiv.classList.remove('hidden');
            }
            
            toggleCardsVisibility();
        }

        function toggleCardsVisibility() {
            const selectedFilterType = document.querySelector('input[name="filterType"]:checked').value;
            const topEmotionsCard = document.getElementById('topEmotionsCard');
            const topIndustriesCard = document.getElementById('topIndustriesCard');
            
            if (selectedFilterType === 'industry') {
                topIndustriesCard.classList.add('hidden');
                topEmotionsCard.classList.remove('hidden');
            } else if (selectedFilterType === 'emotion') {
                topEmotionsCard.classList.add('hidden');
                topIndustriesCard.classList.remove('hidden');
            }
        }

        function createTopicsChart(topicsData) {
            const ctx = document.getElementById('topicsChart').getContext('2d');
            
            if (topicsChart) {
                topicsChart.destroy();
                topicsChart = null;
            }

            const limitedData = topicsData.slice(0, 10);
            
            if (limitedData.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }

            const labels = limitedData.map(item => item.name.charAt(0).toUpperCase() + item.name.slice(1));
            const data = limitedData.map(item => item.count);

            topicsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Engagement Score',
                        data: data,
                        backgroundColor: '#22d3ee',
                        borderColor: '#30363d',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 5,
                            bottom: 5,
                            left: 5,
                            right: 5
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            display: false,
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                color: '#c9d1d9',
                                maxRotation: 45,
                                minRotation: 0,
                                font: {
                                    size: 10
                                },
                                maxTicksLimit: 10
                            },
                            grid: {
                                color: '#30363d'
                            }
                        }
                    },
                    animation: {
                        duration: 500
                    },
                    elements: {
                        bar: {
                            maxBarThickness: 60
                        }
                    }
                }
            });
        }

        function calculateTopMetricsWithCounts(data, key, metric = 'pageviews', limit = 10) {
            const actualKey = DATA_KEY_MAPPING[key];
            const actualMetric = DATA_KEY_MAPPING[metric]; 

            const counts = {};
            data.forEach(item => {
                const rawValue = item[actualKey];
                const score = parseFloat(item[actualMetric]) || 0;

                let valuesToProcess = [];
                if (typeof rawValue === 'string' && rawValue.startsWith('[') && rawValue.endsWith(']')) {
                    try {
                        const parsed = JSON.parse(rawValue.replace(/'/g, '"'));
                        if (Array.isArray(parsed)) {
                            valuesToProcess = parsed.filter(Boolean).map(normalizeValue);
                        } else {
                            valuesToProcess = [normalizeValue(rawValue)];
                        }
                    } catch (e) {
                        valuesToProcess = [normalizeValue(rawValue)];
                    }
                } else if (typeof rawValue === 'string') {
                    valuesToProcess = [normalizeValue(rawValue)];
                } else if (Array.isArray(rawValue)) {
                    valuesToProcess = rawValue.filter(Boolean).map(normalizeValue);
                } else {
                    valuesToProcess = rawValue != null ? [normalizeValue(rawValue)] : [];
                }
                
                valuesToProcess.forEach(value => {
                    if (value !== '') {
                        counts[value] = (counts[value] || 0) + score;
                    }
                });
            });

            const sortedItems = Object.entries(counts)
                .sort(([, countA], [, countB]) => countB - countA);

            if (sortedItems.length === 0) {
                return [`No data available for ${key}`];
            }

            return sortedItems.slice(0, limit).map(([name, count]) => name);
        }

        function calculateMostCommon(data, key) {
            const actualKey = DATA_KEY_MAPPING[key];
            const counts = {};
            data.forEach(item => {
                const rawValue = item[actualKey];
                
                let valuesToProcess = [];
                if (typeof rawValue === 'string' && rawValue.startsWith('[') && rawValue.endsWith(']')) {
                    try {
                        const parsed = JSON.parse(rawValue.replace(/'/g, '"'));
                        if (Array.isArray(parsed)) {
                            valuesToProcess = parsed.filter(Boolean).map(normalizeValue);
                        } else {
                            valuesToProcess = [normalizeValue(rawValue)];
                        }
                    } catch (e) {
                        valuesToProcess = [normalizeValue(rawValue)];
                    }
                } else if (Array.isArray(rawValue)) {
                    valuesToProcess = rawValue.filter(Boolean).map(normalizeValue);
                } else {
                    valuesToProcess = (rawValue !== null && rawValue !== undefined && rawValue !== '' ? [normalizeValue(rawValue)] : []);
                }

                valuesToProcess.forEach(value => {
                     if (value !== '') {
                        counts[value] = (counts[value] || 0) + 1;
                    }
                });
            });

            const sortedItems = Object.entries(counts)
                .sort(([, countA], [, countB]) => countB - countA);

            return sortedItems.length > 0 ? sortedItems[0][0] : 'N/A';
        }

        async function generateAISalesPitch() {
            const salesPitchOutput = document.getElementById('salesPitchOutput');
            const pitchLoading = document.getElementById('pitchLoading');
            const generatePitchBtn = document.getElementById('generatePitchBtn');
            const pitchError = document.getElementById('pitchError');
            const apiKeyInput = document.getElementById('apiKeyInput');
            
            const GEMINI_API_KEY = apiKeyInput.value.trim();
            
            if (!GEMINI_API_KEY) {
                pitchError.textContent = "Please enter your Gemini API key in the configuration section above.";
                pitchError.classList.remove('hidden');
                return;
            }

            if (!currentFilteredArticles || currentFilteredArticles.length === 0) {
                pitchError.textContent = "No data to generate a pitch. Please select a filter with matching articles.";
                pitchError.classList.remove('hidden');
                return;
            }

            const currentFilterDesc = currentFilterValue ? `${currentFilterType}: ${currentFilterValue}` : 'All Content';
            const brandFilterDesc = currentBrandFilter ? ` | Brand: ${currentBrandFilter}` : '';
            const fullFilterDesc = currentFilterDesc + brandFilterDesc;

            const topEmotions = calculateTopMetrics(currentFilteredArticles, 'emotion', 'pageviews', 5);
            const topIndustries = calculateTopMetrics(currentFilteredArticles, 'industry', 'pageviews', 5);
            const topTopics = calculateTopMetrics(currentFilteredArticles, 'topic', 'pageviews', 5);
            const targetGeneration = calculateMostCommon(currentFilteredArticles, 'generation');
            const topSiteSections = calculateTopMetrics(currentFilteredArticles, 'site_section', 'pageviews', 5);
            const topAudienceSegments = calculateTopMetrics(currentFilteredArticles, 'audience_segment', 'pageviews', 5);
            const topCulturalEvents = calculateTopMetrics(currentFilteredArticles, 'cultural_event', 'pageviews', 5);
            const topJobTitles = calculateTopMetrics(currentFilteredArticles, 'job_title', 'pageviews', 5);

            const formatForPrompt = (items) => {
                if (!items || items.length === 0 || (items.length === 1 && items[0].includes('No data for this filter.'))) {
                    return 'N/A';
                }
                return items.join(', ');
            };

            const prompt = `
You're a B2B advertising strategist. Write a compelling sales pitch for an advertiser based on the filtered content performance data. Structure your response as exactly TWO paragraphs:

PARAGRAPH 1 (Primary Sales Pitch - 70-80 words): Focus on the core targeting opportunity, audience segments, and lead generation potential. Emphasize the business value proposition.

PARAGRAPH 2 (Supporting Data & Context - 70-80 words): Detail the additional insights about site sections, cultural events, job titles, and emotional triggers that make this audience particularly valuable.

Filter: "${fullFilterDesc}"  
Matching articles: ${currentFilteredArticles.length}

Key Insights:
- Target Audience Segments: ${formatForPrompt(topAudienceSegments)}
- Emotions most triggered: ${formatForPrompt(topEmotions)}
- Industries most covered: ${formatForPrompt(topIndustries)}
- Topics most covered: ${formatForPrompt(topTopics)}
- Primary target generation: ${targetGeneration || 'N/A'}
- Most-viewed site sections: ${formatForPrompt(topSiteSections)}
- Top cultural events context: ${formatForPrompt(topCulturalEvents)}
- Key job titles reached: ${formatForPrompt(topJobTitles)}

Do not include any introduction or explanation — deliver the two-paragraph pitch directly.
`;

            pitchLoading.classList.remove('hidden');
            generatePitchBtn.disabled = true;
            salesPitchOutput.innerHTML = '';
            pitchError.classList.add('hidden');

            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 300
                }
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            let responseText = '';
            let attempts = 0;
            const maxAttempts = 5;
            let delay = 1000;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            console.warn(`Gemini API Error (${response.status}). Retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                            attempts++;
                            continue;
                        }
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Gemini API Error: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        responseText = result.candidates[0].content.parts[0].text;
                        break;
                    } else {
                        throw new Error("Unexpected API response structure.");
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    responseText = `Error generating pitch: ${error.message}. Please check your API key and try again.`;
                    break;
                }
            }

            pitchLoading.classList.add('hidden');
            generatePitchBtn.disabled = false;

            if (responseText.includes("Error generating pitch")) {
                pitchError.textContent = responseText;
                pitchError.classList.remove('hidden');
                salesPitchOutput.innerHTML = `
                    <div class="flex items-center justify-center h-20 text-gray-500">
                        <div class="text-center">
                            <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 15c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <p>Failed to generate pitch. Please check your API key.</p>
                        </div>
                    </div>
                `;
            } else {
                salesPitchOutput.innerHTML = responseText.split('\n\n').map(paragraph => 
                    `<p class="mb-4 last:mb-0">${paragraph.trim()}</p>`
                ).join('');
            }
        }

        // Initialization and Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            // Set up radio button event listeners
            const filterTypeRadios = document.querySelectorAll('input[name="filterType"]');
            filterTypeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    toggleFilterVisibility();
                    filterDataAndRender();
                });
            });

            // Set up dropdown event listeners
            document.getElementById('selectIndustry').addEventListener('change', filterDataAndRender);
            document.getElementById('selectEmotion').addEventListener('change', filterDataAndRender);
            document.getElementById('selectBrand').addEventListener('change', filterDataAndRender);
            
            // Set up button event listener
            document.getElementById('generatePitchBtn').addEventListener('click', generateAISalesPitch);
            
            // Set initial filter visibility
            toggleFilterVisibility();

            try {
                const response = await fetch(JSON_DATA_PATH);
                if (!response.ok) {
                    throw new Error(`Failed to load data from ${JSON_DATA_PATH}. Status: ${response.status}`);
                }
                allArticleData = await response.json();
                
                const uniqueIndustries = [...new Set(allArticleData.flatMap(d => {
                    const value = d[DATA_KEY_MAPPING['industry']];
                    if (typeof value === 'string' && value.startsWith('[') && value.endsWith(']')) {
                        try {
                            const parsedArray = JSON.parse(value.replace(/'/g, '"')); 
                            return Array.isArray(parsedArray) ? parsedArray.filter(Boolean) : [];
                        } catch (e) {
                            return [value];
                        }
                    }
                    return Array.isArray(value) ? value.filter(Boolean) : (value !== null && value !== undefined && value !== '' ? [value] : []);
                }).filter(Boolean))].sort();

                const uniqueEmotions = [...new Set(allArticleData.flatMap(d => {
                    const value = d[DATA_KEY_MAPPING['emotion']];
                    if (typeof value === 'string' && value.startsWith('[') && value.endsWith(']')) {
                        try {
                            const parsedArray = JSON.parse(value.replace(/'/g, '"'));
                            return Array.isArray(parsedArray) ? parsedArray.filter(Boolean) : [];
                        } catch (e) {
                            return [value];
                        }
                    }
                    return Array.isArray(value) ? value.filter(Boolean) : (value !== null && value !== undefined && value !== '' ? [value] : []);
                }).filter(Boolean))].sort();

                const uniqueBrands = [...new Set(allArticleData.map(d => d[DATA_KEY_MAPPING['brand']]).filter(Boolean))].sort();

                const selectIndustry = document.getElementById('selectIndustry');
                const selectEmotion = document.getElementById('selectEmotion');
                const selectBrand = document.getElementById('selectBrand');
                
                populateDropdown(selectIndustry, uniqueIndustries);
                populateDropdown(selectEmotion, uniqueEmotions);
                populateDropdown(selectBrand, uniqueBrands);

            } catch (error) {
                console.error("Error loading initial JSON data:", error);
                document.getElementById('salesPitchOutput').innerHTML = `
                    <div class="text-red-400 text-center">
                        <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 15c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <p>Error loading data: ${error.message}</p>
                        <p class="text-sm mt-2">Make sure '${JSON_DATA_PATH}' exists and is accessible.</p>
                    </div>
                `;
                document.getElementById('generatePitchBtn').disabled = true;
            } finally {
                await filterDataAndRender();
            }
        });
    </script>
</body>
</html>([, countA], [, countB]) => countB - countA);

            return sortedItems.slice(0, limit).map(([name, count]) => ({ name, count }));
        }

        async function filterDataAndRender() {
            currentFilterType = document.querySelector('input[name="filterType"]:checked').value;
            
            const selectIndustry = document.getElementById('selectIndustry');
            const selectEmotion = document.getElementById('selectEmotion');
            const selectBrand = document.getElementById('selectBrand');
            
            currentFilterValue = normalizeValue(currentFilterType === 'industry' ? selectIndustry.value : selectEmotion.value);
            currentBrandFilter = normalizeValue(selectBrand.value);

            const actualFilterKey = DATA_KEY_MAPPING[currentFilterType];
            const brandFilterKey = DATA_KEY_MAPPING['brand'];

            let filteredData = [...allArticleData];

            if (currentFilterValue !== "") {
                filteredData = filteredData.filter(article => {
                    const articleValue = article[actualFilterKey];
                    let valuesToProcess = [];
                    
                    if (typeof articleValue === 'string' && articleValue.startsWith('[') && articleValue.endsWith(']')) {
                        try {
                            const parsed = JSON.parse(articleValue.replace(/'/g, '"'));
                            if (Array.isArray(parsed)) {
                                valuesToProcess = parsed.filter(Boolean).map(normalizeValue);
                            } else {
                                valuesToProcess = [normalizeValue(articleValue)];
                            }
                        } catch (e) {
                            valuesToProcess = [normalizeValue(articleValue)];
                        }
                    } else if (Array.isArray(articleValue)) {
                        valuesToProcess = articleValue.filter(Boolean).map(normalizeValue);
                    } else {
                        valuesToProcess = (articleValue !== null && articleValue !== undefined && articleValue !== '' ? [normalizeValue(articleValue)] : []);
                    }
                    
                    return valuesToProcess.some(val => val === currentFilterValue);
                });
            }

            if (currentBrandFilter !== "") {
                filteredData = filteredData.filter(article => {
                    const brandValue = article[brandFilterKey];
                    return normalizeValue(brandValue) === currentBrandFilter;
                });
            }

            currentFilteredArticles = filteredData;

            try {
                const topEmotions = calculateTopMetrics(currentFilteredArticles, 'emotion', 'pageviews', 5);
                const topIndustries = calculateTopMetrics(currentFilteredArticles, 'industry', 'pageviews', 5);
                const topTopicsData = calculateTopMetricsWithCounts(currentFilteredArticles, 'topic', 'pageviews', 10);
                const targetGeneration = calculateMostCommon(currentFilteredArticles, 'generation');
                const topSiteSections = calculateTopMetrics(currentFilteredArticles, 'site_section', 'pageviews', 5);
                const topAudienceSegments = calculateTopMetrics(currentFilteredArticles, 'audience_segment', 'pageviews', 5);
                const topCulturalEvents = calculateTopMetrics(currentFilteredArticles, 'cultural_event', 'pageviews', 5);
                const topJobTitles = calculateTopMetrics(currentFilteredArticles, 'job_title', 'pageviews', 5);

                renderList(document.getElementById('topEmotionsList'), topEmotions);
                renderList(document.getElementById('topIndustriesList'), topIndustries);
                document.getElementById('targetGeneration').textContent = targetGeneration;
                renderList(document.getElementById('topSiteSectionsList'), topSiteSections);
                renderList(document.getElementById('topAudienceSegmentsList'), topAudienceSegments);
                renderList(document.getElementById('topCulturalEventsList'), topCulturalEvents);
                renderList(document.getElementById('topJobTitlesList'), topJobTitles);

                if (topTopicsData && topTopicsData.length > 0) {
                    createTopicsChart(topTopicsData);
                } else {
                    if (topicsChart) {
                        topicsChart.destroy();
                        topicsChart = null;
                    }
                }
                
            } catch (error) {
                console.error('Error in filterDataAndRender:', error);
            }
        }

        function renderList(listElement, items) {
            listElement.innerHTML = '';
            if (!items || items.length === 0 || (items.length === 1 && items[0].includes('No data for this filter.'))) {
                listElement.innerHTML = '<li class="text-gray-500 p-2">No data for this filter.</li>';
                return;
            }
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'p-2 rounded-md list-item-hover';
                li.textContent = item;
                listElement.appendChild(li);
            });
        }

        function calculateTopMetrics(data, key, metric = 'pageviews', limit = 5) {
            const actualKey = DATA_KEY_MAPPING[key];
            const actualMetric = DATA_KEY_MAPPING[metric]; 

            if (!data || data.length === 0) {
                return [`No data available for ${key}`];
            }

            const counts = {};
            data.forEach((item, index) => {
                const rawValue = item[actualKey];
                const score = parseFloat(item[actualMetric]) || 1;

                let valuesToProcess = [];
                if (typeof rawValue === 'string' && rawValue.startsWith('[') && rawValue.endsWith(']')) {
                    try {
                        const parsed = JSON.parse(rawValue.replace(/'/g, '"'));
                        if (Array.isArray(parsed)) {
                            valuesToProcess = parsed.filter(Boolean).map(normalizeValue);
                        } else {
                            valuesToProcess = [normalizeValue(rawValue)];
                        }
                    } catch (e) {
                        valuesToProcess = [normalizeValue(rawValue)];
                    }
                } else if (typeof rawValue === 'string') {
                    valuesToProcess = [normalizeValue(rawValue)];
                } else if (Array.isArray(rawValue)) {
                    valuesToProcess = rawValue.filter(Boolean).map(normalizeValue);
                } else {
                    valuesToProcess = rawValue != null ? [normalizeValue(rawValue)] : [];
                }
                
                valuesToProcess.forEach(value => {
                    if (value !== '') {
                        counts[value] = (counts[value] || 0) + score;
                    }
                });
            });

            const sortedItems = Object.entries(counts)
                .sort(